<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ancient Earth - Deep Time Whispers</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Raleway:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-053192S64K"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        
        gtag('config', 'G-053192S64K', {
            page_title: 'Ancient Earth Viewer',
            page_location: window.location.href
        });
        
        // Track Ancient Earth interactions
        function trackAncientEarthEvent(eventType, details = {}) {
            gtag('event', 'ancient_earth_interaction', {
                event_category: 'Ancient Earth',
                event_label: eventType,
                custom_parameter_1: 'ancient_earth_page',
                ...details
            });
        }
        
        // Track time slider changes
        function trackTimeChange(mya) {
            trackAncientEarthEvent('time_change', {
                million_years_ago: mya
            });
        }
        
        // Track location searches
        function trackLocationSearch(location) {
            gtag('event', 'search', {
                search_term: location,
                event_category: 'Ancient Earth'
            });
        }
        
        // Track location pins
        function trackLocationPin(lat, lng, mya) {
            trackAncientEarthEvent('location_pin', {
                latitude: lat,
                longitude: lng,
                million_years_ago: mya
            });
        }
    </script>
    
    <style>
        :root {
            --primary-purple: #7B1FA2;
            --deep-purple: #4A148C;
            --cosmic-teal: #4DB6AC;
            --midnight: #1A237E;
            --stardust: #E1BEE7;
            --nebula: #7E57C2;
            --space-black: #0A0E27;
            --soft-white: #F5F5F5;
            --text-light: #B39DDB;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Raleway', sans-serif;
            background: var(--space-black);
            color: var(--soft-white);
            overflow: hidden;
            position: relative;
        }
        
        /* Cosmic Background Animation */
        .cosmic-bg {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
            background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
            overflow: hidden;
        }
        
        .stars {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            width: 1px;
            height: 1px;
            background: transparent;
            box-shadow: 779px 1331px #fff, 324px 42px #fff, 303px 586px #fff, 1312px 276px #fff, 451px 625px #fff;
            animation: drift 120s linear infinite;
        }
        
        @keyframes drift {
            from { transform: translateY(0px); }
            to { transform: translateY(-1000px); }
        }
        
        #container {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        
        /* Navigation */
        .nav {
            position: fixed;
            top: 0;
            width: 100%;
            background: rgba(10, 14, 39, 0.9);
            backdrop-filter: blur(10px);
            z-index: 1000;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem 2rem;
        }
        
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .nav-content {
                padding: 0.8rem 1rem;
                flex-wrap: wrap;
                min-height: auto;
            }
            
            .logo-text {
                font-size: 1.2rem;
            }
            
            .logo-short {
                display: inline;
            }
            
            .logo-full {
                display: none;
            }
            
            .nav-links {
                gap: 0.5rem;
                flex-wrap: wrap;
                justify-content: center;
                width: 100%;
                margin-top: 0.4rem;
                margin-bottom: 0.2rem;
            }
            
            .nav-link {
                font-size: 0.8rem;
                padding: 0.3rem 0.5rem;
                white-space: nowrap;
                border-radius: 8px;
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .nav-link:hover,
            .nav-link.active {
                background: rgba(77, 182, 172, 0.2);
                border-color: var(--cosmic-teal);
            }
        }
        
        .logo-text {
            font-family: 'Crimson Text', serif;
            font-size: 1.8rem;
            font-weight: 600;
            background: linear-gradient(45deg, var(--stardust), var(--cosmic-teal));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-decoration: none;
        }
        
        .logo-short {
            display: none;
        }
        
        .logo-full {
            display: inline;
        }
        
        .nav-links {
            display: flex;
            gap: 2rem;
            align-items: center;
        }
        
        .nav-link {
            color: var(--text-light);
            text-decoration: none;
            transition: color 0.3s ease;
            font-weight: 400;
            font-family: 'Raleway', sans-serif;
        }
        
        .nav-link:hover {
            color: var(--cosmic-teal);
        }
        
        .nav-link.active {
            color: var(--cosmic-teal);
        }
        
        /* Top controls bar */
        .top-bar {
            position: fixed;
            top: 120px; /* Increased more to ensure no cut-off */
            left: 0;
            right: 0;
            height: 80px;
            background: rgba(10, 14, 39, 0.95);
            padding: 15px 20px;
            text-align: center;
            z-index: 100;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .top-bar {
                top: 80px; /* Adjusted for mobile navigation */
                height: 30px;
                padding: 2px 10px;
                gap: 5px;
                flex-direction: row;
                justify-content: center;
                align-items: center;
            }
        }
        
        .top-bar h1 {
            font-family: 'Crimson Text', serif;
            font-size: 1.5rem;
            font-weight: 400;
            margin: 0;
            letter-spacing: 1px;
            background: linear-gradient(45deg, var(--stardust), var(--cosmic-teal));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        @media (max-width: 768px) {
            .top-bar h1 {
                display: none;
            }
        }
        
        /* Hide mobile menu toggle on desktop */
        .mobile-menu-toggle {
            display: none;
        }
        
        /* Ensure navigation uses consistent fonts */
        nav, .nav, .nav-content, .nav-links {
            font-family: 'Raleway', sans-serif !important;
        }
        
        /* Main content area */
        .main-content {
            position: fixed;
            top: 200px; /* Increased to match new top-bar position (120px + 80px) */
            left: 0;
            right: 0;
            bottom: 120px;
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 0;
        }
        
        /* Completely different mobile layout - globe takes most of screen */
        @media (max-width: 768px) {
            .main-content {
                top: 80px; /* Much smaller top */
                bottom: 0; /* No bottom space */
                left: 0;
                right: 0;
                display: flex;
                flex-direction: column;
                grid-template-columns: none;
                grid-template-rows: none;
            }
            
            /* Hide navigation on mobile to save space */
            .nav {
                position: fixed;
                top: -100px;
                transition: top 0.3s ease;
                z-index: 2000;
            }
            
            .nav.visible {
                top: 0;
            }
            
            /* Add mobile menu toggle - show on mobile */
            .mobile-menu-toggle {
                display: block !important;
                position: fixed;
                top: 10px;
                left: 10px;
                z-index: 2001;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                border: none;
                padding: 10px;
                border-radius: 5px;
                font-size: 18px;
                cursor: pointer;
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
            }
            
            /* Make top-bar much smaller on mobile */
            .top-bar {
                position: fixed;
                top: 0;
                height: 50px;
                padding: 5px 10px;
                font-size: 12px;
                background: rgba(10, 14, 39, 0.95);
            }
            
            /* Globe takes most of the screen */
            .globe-area {
                flex: 1;
                height: calc(100vh - 130px) !important; /* Account for top bar and info */
                width: 100vw !important;
                order: 1;
                position: relative;
            }
            
            #container {
                width: 100% !important;
                height: 100% !important;
                position: absolute;
                top: 0;
                left: 0;
            }
            
            /* Make canvas responsive */
            canvas {
                width: 100% !important;
                height: 100% !important;
                max-width: 100vw;
                max-height: calc(100vh - 130px);
            }
            
            /* Info panel as overlay */
            .info-area {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                height: 80px;
                background: rgba(0, 0, 0, 0.9);
                backdrop-filter: blur(10px);
                order: 2;
                overflow-y: auto;
                z-index: 1000;
            }
            
            .info-panel {
                margin: 5px;
                padding: 8px;
                font-size: 11px;
            }
            
            .info-panel h2 {
                font-size: 14px;
                margin: 0 0 3px 0;
            }
            
            .info-panel .period {
                font-size: 12px;
                margin: 0 0 3px 0;
            }
            
            .location-panel {
                display: none; /* Hide on mobile to save space */
            }
        }
        
        /* Globe area */
        .globe-area {
            position: relative;
            background: radial-gradient(ellipse at center, #1b2735 0%, #090a0f 100%);
            overflow: hidden;
        }
        
        /* Side panel */
        .side-panel {
            background: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(10px);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0; /* Remove gap to control spacing manually */
            height: 100%; /* Ensure full height */
            box-sizing: border-box; /* Include padding in height calculation */
        }
        
        @media (max-width: 768px) {
            .side-panel {
                border-left: none;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
                padding: 8px;
                height: auto;
                min-height: 60px;
                overflow-y: auto;
            }
        }
        
        /* Animation controls */
        .animation-controls {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
            margin-top: 15px;
        }
        
        @media (max-width: 768px) {
            .animation-controls {
                gap: 5px;
                flex-wrap: nowrap;
                margin-top: 0;
                justify-content: flex-end;
                align-items: center;
                flex-shrink: 0;
            }
        }
        
        .control-btn {
            background: rgba(33, 150, 243, 0.8);
            border: 2px solid transparent;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .control-btn {
                padding: 4px 8px;
                font-size: 10px;
                border-radius: 15px;
            }
        }
        
        .control-btn:hover {
            background: rgba(33, 150, 243, 1);
            transform: scale(1.05);
        }
        
        .control-btn.active {
            background: #4CAF50;
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        /* Timeline slider */
        /* Bottom timeline bar */
        .timeline-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 120px;
            background: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        @media (max-width: 768px) {
            .timeline-container {
                height: 60px;
                padding: 8px 15px;
                left: 0;
                right: 0;
                width: 100%;
            }
        }
        
        .timeline-slider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            outline: none;
        }
        
        .timeline-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #2196F3;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 0 10px rgba(33, 150, 243, 0.5);
        }
        
        .timeline-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 12px;
            opacity: 0.8;
        }
        
        /* Speed control */
        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 20px;
        }
        
        @media (max-width: 768px) {
            .speed-control {
                padding: 3px 8px;
                gap: 4px;
                border-radius: 15px;
            }
            
            .speed-control label {
                font-size: 0.7rem;
            }
        }
        
        .speed-slider {
            width: 100px;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            outline: none;
        }
        
        .speed-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .speed-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .speed-btn {
                padding: 3px 6px;
                font-size: 10px;
                border-radius: 10px;
            }
        }
        
        .speed-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        .speed-btn.active {
            background: #64B5F6;
            border-color: #64B5F6;
            color: white;
        }
        
        /* Info panel */
        .info-panel {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 0; /* Remove bottom margin to use flex gap instead */
            border: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0; /* Prevent shrinking */
            position: relative; /* Ensure proper positioning */
            z-index: 2; /* Higher z-index than location panel */
        }
        
        @media (max-width: 768px) {
            .info-panel {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .info-panel h2 {
                font-size: 20px;
            }
            
            .info-panel .period {
                font-size: 16px;
            }
        }
        
        .info-panel h2 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #64B5F6;
        }
        
        .info-panel .period {
            color: #FFD700;
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .info-panel .frame-info {
            font-size: 12px;
            opacity: 0.6;
            margin-top: 10px;
        }
        
        /* Location tracking */
        .location-panel {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 30px; /* Increased space between panels */
            flex-shrink: 0; /* Prevent shrinking */
            position: relative; /* Ensure proper positioning */
            z-index: 1; /* Ensure it doesn't overlap */
        }
        
        .location-panel h3 {
            margin-bottom: 15px;
            color: #64B5F6;
        }
        
        .search-box {
            display: flex;
            margin-bottom: 10px;
        }
        
        .search-input {
            flex: 1;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px 0 0 5px;
            color: white;
            font-size: 14px;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #64B5F6;
            background: rgba(255, 255, 255, 0.15);
        }
        
        .search-btn {
            padding: 10px 20px;
            background: #2196F3;
            border: none;
            color: white;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
            font-size: 14px;
        }
        
        .search-btn:hover {
            background: #1976D2;
        }
        
        .preset-locations {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        
        @media (max-width: 768px) {
            .preset-locations {
                gap: 3px;
            }
            
            .preset-btn {
                padding: 4px 8px;
                font-size: 11px;
            }
        }
        
        .preset-btn {
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .preset-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #64B5F6;
        }
        
        /* Controls hint */
        .controls-hint {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            font-size: 13px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            z-index: 1000;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        canvas {
            display: block;
            cursor: grab;
        }
        
        canvas:active {
            cursor: grabbing;
        }
        
        /* Mobile responsive styles cleaned up */
        
        .timeline-slider {
            width: 100%;
            margin: 10px 0;
        }
        
        .timeline-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }
            
        .top-bar {
                flex-direction: column;
                height: 100px;
                padding: 10px;
                gap: 10px;
            }
            
            .top-bar h1 {
                font-size: 1.2rem;
                margin-bottom: 5px;
            }
            
            .animation-controls {
                flex-wrap: wrap;
                gap: 10px;
                justify-content: center;
            }
            h1 {
                font-size: 16px;
                margin-bottom: 10px;
                margin-right: 10px;
            }
            
            .nav-links {
                font-size: 0.75rem !important;
                gap: 0.4rem !important;
                flex-wrap: wrap !important;
                justify-content: center !important;
            }
            
            .nav-link {
                padding: 0.25rem 0.4rem !important;
                font-size: 0.75rem !important;
            }
            
            .top-bar {
                padding: 10px;
            }
            
            .animation-controls {
                flex-direction: column;
                gap: 10px;
                margin-top: 10px;
            }
            
            .control-btn {
                padding: 8px 16px;
                font-size: 12px;
            }
            
            .timeline-container {
                width: 100%;
                bottom: 0;
                height: 60px;
                padding: 10px;
            }
            
            .timeline-labels {
                font-size: 10px;
            }
            
            .info-panel {
                position: fixed;
                bottom: auto;
                top: 120px;
                left: 10px;
                right: 10px;
                padding: 12px;
                max-width: none;
                font-size: 12px;
                max-height: 25vh;
                overflow-y: auto;
            }
            
            .info-panel h2 {
                font-size: 20px;
            }
            
            .location-panel {
                position: fixed;
                bottom: 180px;
                right: auto;
                left: 10px;
                right: 10px;
                width: auto;
                padding: 12px;
                background: rgba(0, 0, 0, 0.95);
            }
            
            .location-panel h3 {
                font-size: 16px;
                margin-bottom: 10px;
            }
            
            .preset-locations {
                gap: 3px;
            }
            
            .preset-btn {
                font-size: 11px;
                padding: 4px 8px;
            }
            
            .search-box {
                display: none; /* Hide search on mobile */
            }
            
            .controls-hint {
                top: 80px;
                right: 10px;
                padding: 10px;
                font-size: 12px;
            }
            
            .speed-control {
                padding: 8px 15px;
            }
            
            .speed-slider {
                width: 80px;
            }
            
            /* Hide some timeline labels on mobile */
            .timeline-labels span:nth-child(even) {
                display: none;
            }
        }
        
        @media (max-width: 480px) {
            .logo-short {
                display: inline;
            }
            
            .logo-full {
                display: none;
            }
            
            h1 {
                font-size: 14px;
            }
            
            .nav-links {
                font-size: 0.7rem !important;
                gap: 0.3rem !important;
                flex-wrap: wrap !important;
                justify-content: center !important;
            }
            
            .nav-link {
                padding: 0.2rem 0.3rem !important;
                font-size: 0.7rem !important;
            }
            
            .info-panel {
                font-size: 11px;
                padding: 10px;
                top: 100px;
            }
            
            .info-panel h2 {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Cosmic Background Animation -->
    <div class="cosmic-bg">
        <div class="stars"></div>
        <div class="stars2"></div>
        <div class="stars3"></div>
        <div class="nebula"></div>
    </div>
    
    <!-- Navigation -->
    <nav class="nav">
        <div class="container">
            <div class="nav-content">
                <div class="logo">
                    <a href="index.html" class="logo-text">
                        <span class="logo-full">Deep Time Whispers</span>
                        <span class="logo-short">DTW</span>
                    </a>
                </div>
                <div class="nav-links">
                    <a href="index.html" class="nav-link">Home</a>
                    <a href="timeline.html" class="nav-link">Timeline</a>
                    <a href="ancient-earth-viewer.html" class="nav-link active">Ancient Earth</a>
                    <a href="cosmic-calendar.html" class="nav-link">Cosmic Calendar</a>
                    <a href="episodes.html" class="nav-link">Episodes</a>
                    <a href="ask-chrononaut.html" class="nav-link">Ask Chrononaut</a>
                    <a href="index.html#about" class="nav-link">About</a>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">☰</button>
    
    <!-- Top Control Bar -->
    <div class="top-bar">
        <h1>Journey Through Ancient Earth</h1>
        <div class="animation-controls">
            <button class="control-btn" onclick="togglePlay()">
                <span id="playText">▶ Play Animation</span>
            </button>
            <div class="speed-control">
                <label>Speed:</label>
                <button class="speed-btn" onclick="setSpeed(1)">1x</button>
                <button class="speed-btn active" onclick="setSpeed(3)">3x</button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Globe Area -->
        <div class="globe-area">
            <div id="container">
                <div id="loading">
                    <div class="spinner"></div>
                    <div>Loading 90 time period textures...</div>
                    <div id="loadProgress">0/90</div>
                </div>
            </div>
        </div>
        
        <!-- Side Panel -->
        <div class="side-panel">
            <div class="credits-link" style="text-align: center; margin-bottom: 0; padding: 10px; flex-shrink: 0;">
                <a href="credits.html" style="color: #64B5F6; text-decoration: none; font-size: 0.9em;">Credits</a>
            </div>
            
            <div class="info-panel">
                <h2 id="periodName">Present Day</h2>
                <div class="period" id="periodTime">0 Million Years Ago</div>
                <p id="periodDesc">Loading description...</p>
                <div class="frame-info">Frame: <span id="frameInfo">1/90</span></div>
            </div>
            
            <div class="location-panel">
                <h3>Track Location Through Time</h3>
                <div class="search-box">
                    <input type="text" class="search-input" id="locationInput" placeholder="City or lat,lng">
                    <button class="search-btn" onclick="searchLocation()">Track</button>
                </div>
                <div class="preset-locations">
                    <button class="preset-btn" onclick="trackLocation('New York', 40.7128, -74.0060)">New York</button>
                    <button class="preset-btn" onclick="trackLocation('London', 51.5074, -0.1278)">London</button>
                    <button class="preset-btn" onclick="trackLocation('Tokyo', 35.6762, 139.6503)">Tokyo</button>
                    <button class="preset-btn" onclick="trackLocation('Sydney', -33.8688, 151.2093)">Sydney</button>
                    <button class="preset-btn" onclick="trackLocation('Paris', 48.8566, 2.3522)">Paris</button>
                    <button class="preset-btn" onclick="trackLocation('Beijing', 39.9042, 116.4074)">Beijing</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Bottom Timeline Bar -->
    <div class="timeline-container">
        <input type="range" class="timeline-slider" id="timelineSlider" 
               min="0" max="750" value="0" step="1" oninput="jumpToMYA(this.value)">
        <div class="timeline-labels">
            <span>Present</span>
            <span>100 MYA</span>
            <span>200 MYA</span>
            <span>300 MYA</span>
            <span>400 MYA</span>
            <span>500 MYA</span>
            <span>600 MYA</span>
            <span>750 MYA</span>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Mobile menu toggle function
        function toggleMobileMenu() {
            const nav = document.querySelector('.nav');
            nav.classList.toggle('visible');
        }
        
        // Show mobile menu button only on mobile
        function checkMobile() {
            const mobileToggle = document.querySelector('.mobile-menu-toggle');
            const nav = document.querySelector('.nav');
            if (window.innerWidth <= 768) {
                if (mobileToggle) mobileToggle.style.display = 'block';
            } else {
                if (mobileToggle) mobileToggle.style.display = 'none';
                if (nav) nav.classList.remove('visible');
            }
        }
        
        window.addEventListener('resize', checkMobile);
        document.addEventListener('DOMContentLoaded', () => {
            checkMobile();
            // Force initial render after DOM loads
            setTimeout(checkMobile, 100);
        });
        
        // Scene globals
        let scene, camera, renderer;
        let earth;
        let locationPin;
        let controls = {};
        
        // Animation state
        let currentFrame = 0;
        let isPlaying = false;
        let animationSpeed = 3;
        let lastFrameTime = 0;
        let frameInterval = 166; // ms between frames (500/3 for 3x speed)
        
        // Textures array
        const textures = [];
        const textureLoader = new THREE.TextureLoader();
        let loadedCount = 0;
        
        // Location tracking
        let currentLocation = null;
        
        // All 90 texture files in order
        const textureFileNames = [
            "Map1a PALEOMAP PaleoAtlas_000.jpg",
            "Map2a Last Glacial Maximum_001.jpg",
            "Map3a Pliocene_004.jpg",
            "Map4a Messinian Event_006.jpg",
            "Map5a Late Miocene_010.jpg",
            "Map6a  Middle Miocene_015.jpg",
            "Map7a  Early Miocene_020.jpg",
            "Map8a Late Oligocene_025.jpg",
            "Map9a  Early Oligocene_030.jpg",
            "Map10a Late Eocene_035.jpg",
            "Map11a MIddle Eocene_040.jpg",
            "Map12a early Middle Eocene_045.jpg",
            "Map13a Early Eocene_050.jpg",
            "Map14a PETM_055.jpg",
            "Map15a Paleocene_060.jpg",
            "Map16a KT Boundary_066.jpg",
            "Map17a LtK Maastrichtian_070.jpg",
            "Map18a LtK Late Campanian_075.jpg",
            "Map19a LtK Early Campanian_080.jpg",
            "Map21a LtK Turonian_090.jpg",
            "Map22a LtK Cenomanian_095.jpg",
            "Map23a EK Late Albian_100.jpg",
            "Map24a EK Middle Albian_105.jpg",
            "Map25a EK Early Albian_110.jpg",
            "Map26a EK Late Aptian_115.jpg",
            "Map27a EK Early Albian_120.jpg",
            "Map28a EK Barremian_125.jpg",
            "Map29a EK Hauterivian_130.jpg",
            "Map30a EK Valangian_135.jpg",
            "Map31a EK Berriasian_140.jpg",
            "Map32a Jurassic-Cretaceous Boundary_145.jpg",
            "Map33a LtJ Tithonian_150.jpg",
            "Map34a LtJ Kimmeridgian_155.jpg",
            "Map35a LtJ Oxfordian_160.jpg",
            "Map36a MJ Callovian_165.jpg",
            "Map37a MJ Bajocian&Bathonian_170.jpg",
            "Map38a MJ Aalenian_175.jpg",
            "Map39a EJ Toarcian_180.jpg",
            "Map40a EJ Pliensbachian_185.jpg",
            "Map41a EJ Sinemurian_190.jpg",
            "Map42a EJ Hettangian_195.jpg",
            "Map43a Triassic-Jurassic Boundary_200.jpg",
            "Map44a LtTr Norian_210.jpg",
            "Map45a LtTr Carnian_220.jpg",
            "Map46a MTr Ladinian_230.jpg",
            "Map47a MTr Anisian_240.jpg",
            "Map48a ETr Induan-Olenekian_245.jpg",
            "Map49a Permo-Triassic Boundary_250.jpg",
            "Map50a LtP Lopingian_255.jpg",
            "Map51a LtP Capitanian_260.jpg",
            "Map52a MP Roadian&Wordian_270.jpg",
            "Map53a EP Kungurian_275.jpg",
            "Map54a EP Artinskian_280.jpg",
            "Map55a EP Sakmarian_290.jpg",
            "Map56a EP Asselian_295.jpg",
            "Map57a LtCarb Gzhelian_300.jpg",
            "Map58a LtCarb Kasimovian_305.jpg",
            "Map59a LtCarb Moscovian_310.jpg",
            "Map60a LtCarb Bashkirian_315.jpg",
            "Map61a ECarb Serpukhovian_320.jpg",
            "Map62a ECarb Late Visean_330.jpg",
            "Map63a ECarb Early Visean_340.jpg",
            "Map64a ECarb Tournaisian_350.jpg",
            "Map65a Devono-Carboniferous Boundary_360.jpg",
            "Map66a LtD Famennian_370.jpg",
            "Map67a LtD Frasnian_380.jpg",
            "Map68a MD Givetian_390.jpg",
            "Map69a MD Eifelian_395.jpg",
            "Map70a ED Emsian_400.jpg",
            "Map71a ED Pragian_410.jpg",
            "Map72a ED Lochlovian_415.jpg",
            "Map73a LtS  Ludlow&Pridoli_420.jpg",
            "Map74a MS Wenlock_425.jpg",
            "Map75a ES late Llandovery_430.jpg",
            "Map76a ES early Llandovery_440.jpg",
            "Map77a LtO Hirnantian_445.jpg",
            "Map78a LtO Sandbian-Katian_450.jpg",
            "Map79a LtO Caradoc_460.jpg",
            "Map80a LtO Darwillian_461.jpg",
            "Map81a EO Floian-Dapingian_470.jpg",
            "Map82a EO Tremadoc_480.jpg",
            "Map83a Cambro-Ordovician Boundary_490.jpg",
            "Map84a LtC Furongian_500.jpg",
            "Map85a early Late Cambrian Series 3_510.jpg",
            "Map86a Middle Cambrian Series 2_520.jpg",
            "Map87a Early Cambrian Terreneuvian_530.jpg",
            "Map88a Precambrian-Cambrian Boundary_540.jpg",
            "Map90a Middle Ediacaran_600.jpg",
            "Map92a Late Cryogenian_690.jpg",
            "Map93a MIddle Cryogenian_750.jpg"
        ];
        
        function init() {
            // Scene setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000511);
            
            // Get container dimensions - force full size on mobile
            const container = document.getElementById('container');
            let containerWidth = container.clientWidth;
            let containerHeight = container.clientHeight;
            
            // Force mobile dimensions if needed
            if (window.innerWidth <= 768) {
                containerWidth = window.innerWidth;
                containerHeight = window.innerHeight - 130; // Account for UI
                container.style.width = containerWidth + 'px';
                container.style.height = containerHeight + 'px';
            }
            
            // Camera
            camera = new THREE.PerspectiveCamera(45, containerWidth / containerHeight, 0.1, 1000);
            camera.position.set(0, 0, 3);
            
            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(containerWidth, containerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);
            
            // Lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 0.8);
            scene.add(ambientLight);
            
            const sunlight = new THREE.DirectionalLight(0xffffff, 1);
            sunlight.position.set(5, 3, 5);
            scene.add(sunlight);
            
            // Add stars
            createStarfield();
            
            // Create Earth
            createEarth();
            
            // Create location pin
            createLocationPin();
            
            // Setup controls
            setupControls();
            
            // Load all textures
            loadAllTextures();
            
            // Handle window resize
            window.addEventListener('resize', onWindowResize);
            
            // Start render loop
            animate();
        }
        
        function createStarfield() {
            const starsGeometry = new THREE.BufferGeometry();
            const starCount = 5000;
            const positions = [];
            
            for (let i = 0; i < starCount; i++) {
                const radius = 100 + Math.random() * 400;
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos(2 * Math.random() - 1);
                
                positions.push(
                    radius * Math.sin(phi) * Math.cos(theta),
                    radius * Math.sin(phi) * Math.sin(theta),
                    radius * Math.cos(phi)
                );
            }
            
            starsGeometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            
            const starsMaterial = new THREE.PointsMaterial({
                color: 0xffffff,
                size: 1,
                sizeAttenuation: false
            });
            
            const stars = new THREE.Points(starsGeometry, starsMaterial);
            scene.add(stars);
        }
        
        function createEarth() {
            const geometry = new THREE.SphereGeometry(1, 128, 64);
            const material = new THREE.MeshPhongMaterial({
                color: 0x2194ce,
                shininess: 20
            });
            earth = new THREE.Mesh(geometry, material);
            scene.add(earth);
        }
        
        function createLocationPin() {
            // Create a group for the pin
            locationPin = new THREE.Group();
            
            // Create a modern circular beacon design
            // Inner bright dot
            const dotGeometry = new THREE.SphereGeometry(0.015, 16, 16);
            const dotMaterial = new THREE.MeshBasicMaterial({ 
                color: 0xffffff,
                emissive: 0xffffff
            });
            const dot = new THREE.Mesh(dotGeometry, dotMaterial);
            locationPin.add(dot);
            
            // Outer ring - oriented to lie flat on the surface
            const ringGeometry = new THREE.TorusGeometry(0.04, 0.006, 8, 32);
            const ringMaterial = new THREE.MeshBasicMaterial({ 
                color: 0xff4444,
                emissive: 0xff0000,
                transparent: true,
                opacity: 0.9
            });
            const ring = new THREE.Mesh(ringGeometry, ringMaterial);
            // Rotate ring to be horizontal (perpendicular to Y axis)
            ring.rotation.x = Math.PI / 2;
            locationPin.add(ring);
            
            // Pulsing outer glow
            const glowGeometry = new THREE.SphereGeometry(0.06, 16, 16);
            const glowMaterial = new THREE.MeshBasicMaterial({ 
                color: 0xff6666,
                transparent: true,
                opacity: 0.3
            });
            const glow = new THREE.Mesh(glowGeometry, glowMaterial);
            locationPin.add(glow);
            
            // Add a vertical light beam effect pointing away from Earth
            const beamGeometry = new THREE.CylinderGeometry(0.002, 0.015, 0.15, 8);
            const beamMaterial = new THREE.MeshBasicMaterial({ 
                color: 0xffffff,
                transparent: true,
                opacity: 0.5
            });
            const beam = new THREE.Mesh(beamGeometry, beamMaterial);
            // Position beam to point outward from the surface
            beam.position.y = 0.075;  // Move along local Y axis (which will be outward after orientation)
            // No rotation needed - cylinder already points along Y axis
            locationPin.add(beam);
            
            // Store references for animation
            locationPin.userData = { ring, glow, beam };
            
            locationPin.visible = false;
            // Will be added to Earth when location is tracked
        }
        
        function loadAllTextures() {
            // Load all 90 textures
            for (let i = 0; i < 90; i++) {
                // Fix path for different hosting environments
                const basePath = window.location.hostname.includes('vercel.app') 
                    ? '/textures/paleomap/timeline'
                    : 'textures/paleomap/timeline';
                const fileName = `${basePath}/${textureFileNames[i]}`;
                
                textureLoader.load(
                    fileName,
                    (texture) => {
                        textures[i] = texture;
                        loadedCount++;
                        document.getElementById('loadProgress').textContent = `${loadedCount}/90`;
                        
                        if (loadedCount === 90) {
                            // All textures loaded
                            document.getElementById('loading').style.display = 'none';
                            updateFrame(0);
                        }
                    },
                    undefined,
                    (error) => {
                        console.error(`Failed to load texture ${i} (${textureFileNames[i]}):`, error);
                        // Try to use previous texture as fallback
                        textures[i] = textures[i-1] || null;
                        loadedCount++;
                        document.getElementById('loadProgress').textContent = `${loadedCount}/90`;
                        
                        if (loadedCount === 90) {
                            document.getElementById('loading').style.display = 'none';
                            updateFrame(0);
                        }
                    }
                );
            }
        }
        
        async function updateFrame(frameIndex) {
            if (!earth || !textures[frameIndex]) return;
            
            currentFrame = frameIndex;
            earth.material.map = textures[frameIndex];
            earth.material.needsUpdate = true;
            
            // Update UI
            const timeData = getTimeForFrame(frameIndex);
            document.getElementById('periodName').textContent = timeData.name;
            document.getElementById('periodTime').textContent = `${timeData.mya} Million Years Ago`;
            document.getElementById('frameInfo').textContent = `${frameIndex + 1}/90`;
            document.getElementById('timelineSlider').value = timeData.mya;
            
            // Update period description
            const description = getPeriodDescription(timeData.mya);
            document.getElementById('periodDesc').textContent = description;
            
            // Update location
            if (currentLocation) {
                await updateLocationForFrame(frameIndex);
            }
        }
        
        function getTimeForFrame(frameIndex) {
            const filename = textureFileNames[frameIndex];
            
            // Time mapping based on PALEOMAP sequence
            // The files are ordered from present (0 MYA) to past (750 MYA)
            const timeMapping = [
                0,    // Map1a Present
                0.02, // Map2a Last Glacial Maximum
                4,    // Map3a Pliocene
                6,    // Map4a Messinian
                10,   // Map5a Late Miocene
                15,   // Map6a Middle Miocene
                20,   // Map7a Early Miocene
                25,   // Map8a Late Oligocene
                30,   // Map9a Early Oligocene
                35,   // Map10a Late Eocene
                40,   // Map11a Middle Eocene
                45,   // Map12a early Middle Eocene
                50,   // Map13a Early Eocene
                55,   // Map14a PETM
                60,   // Map15a Paleocene
                66,   // Map16a KT Boundary
                70,   // Map17a Maastrichtian
                75,   // Map18a Late Campanian
                80,   // Map19a Early Campanian
                90,   // Map21a Turonian
                95,   // Map22a Cenomanian
                100,  // Map23a Late Albian
                105,  // Map24a Middle Albian
                110,  // Map25a Early Albian
                115,  // Map26a Late Aptian
                120,  // Map27a Early Albian (duplicate?)
                125,  // Map28a Barremian
                130,  // Map29a Hauterivian
                135,  // Map30a Valangian
                140,  // Map31a Berriasian
                145,  // Map32a Jurassic-Cretaceous
                150,  // Map33a Tithonian
                155,  // Map34a Kimmeridgian
                160,  // Map35a Oxfordian
                165,  // Map36a Callovian
                170,  // Map37a Bajocian&Bathonian
                175,  // Map38a Aalenian
                180,  // Map39a Toarcian
                185,  // Map40a Pliensbachian
                190,  // Map41a Sinemurian
                195,  // Map42a Hettangian
                200,  // Map43a Triassic-Jurassic
                210,  // Map44a Norian
                220,  // Map45a Carnian
                230,  // Map46a Ladinian
                240,  // Map47a Anisian
                245,  // Map48a Induan-Olenekian
                250,  // Map49a Permo-Triassic
                255,  // Map50a Lopingian
                260,  // Map51a Capitanian
                270,  // Map52a Roadian&Wordian
                275,  // Map53a Kungurian
                280,  // Map54a Artinskian
                290,  // Map55a Sakmarian
                295,  // Map56a Asselian
                300,  // Map57a Gzhelian
                305,  // Map58a Kasimovian
                310,  // Map59a Moscovian
                315,  // Map60a Bashkirian
                320,  // Map61a Serpukhovian
                330,  // Map62a Late Visean
                340,  // Map63a Early Visean
                350,  // Map64a Tournaisian
                360,  // Map65a Devono-Carboniferous
                370,  // Map66a Famennian
                380,  // Map67a Frasnian
                390,  // Map68a Givetian
                395,  // Map69a Eifelian
                400,  // Map70a Emsian
                410,  // Map71a Pragian
                415,  // Map72a Lochlovian
                420,  // Map73a Ludlow&Pridoli
                425,  // Map74a Wenlock
                430,  // Map75a late Llandovery
                440,  // Map76a early Llandovery
                445,  // Map77a Hirnantian
                450,  // Map78a Sandbian-Katian
                460,  // Map79a Caradoc
                461,  // Map80a Darwillian
                470,  // Map81a Floian-Dapingian
                480,  // Map82a Tremadoc
                490,  // Map83a Cambro-Ordovician
                500,  // Map84a Furongian
                510,  // Map85a Late Cambrian
                520,  // Map86a Middle Cambrian
                530,  // Map87a Early Cambrian
                540,  // Map88a Precambrian-Cambrian
                600,  // Map90a Middle Ediacaran
                690,  // Map92a Late Cryogenian
                750   // Map93a Middle Cryogenian
            ];
            
            const mya = timeMapping[frameIndex] || 0;
            
            // Extract period name from filename
            let name = filename.replace(/Map\d+[a-z]?\s+/, '') // Remove Map prefix
                              .replace(/_\d+\.jpg/, '')      // Remove time suffix
                              .trim();
            
            // Special cases
            if (frameIndex === 0) name = "Present Day";
            if (name.includes("PALEOMAP PaleoAtlas")) name = "Present Day";
            
            return { mya, name };
        }
        
        function getPeriodDescription(mya) {
            // Period descriptions based on time
            if (mya === 0) return "The modern world with seven continents. Ice caps at both poles define our current interglacial period.";
            if (mya <= 5) return "Recent geological time. The continents are essentially in their modern positions.";
            if (mya <= 20) return "The Miocene epoch. Grasslands expanded as climate cooled and dried. The Himalayas continued rising.";
            if (mya <= 40) return "The Eocene epoch. A warm greenhouse world with no polar ice. Early mammals diversified.";
            if (mya <= 66) return "The Paleocene epoch. Recovery from the asteroid impact that killed the dinosaurs.";
            if (mya <= 100) return "The Late Cretaceous. Peak of the dinosaur era with high sea levels creating inland seas.";
            if (mya <= 145) return "The Jurassic period. The age of giant dinosaurs as Pangaea began breaking apart.";
            if (mya <= 200) return "The Triassic period. Recovery from the Great Dying. First dinosaurs appeared.";
            if (mya <= 250) return "The Permian period. Pangaea supercontinent formed. Ended with Earth's largest extinction.";
            if (mya <= 300) return "The Carboniferous period. Vast coal swamps and giant insects in high-oxygen atmosphere.";
            if (mya <= 360) return "The Devonian period. Age of Fishes. First forests and tetrapods evolved.";
            if (mya <= 420) return "The Silurian period. Life moved onto land. First vascular plants appeared.";
            if (mya <= 485) return "The Ordovician period. Marine life exploded in diversity. First coral reefs formed.";
            if (mya <= 540) return "The Cambrian period. The Cambrian Explosion - most animal body plans evolved.";
            if (mya <= 650) return "The Ediacaran period. First complex multicellular life after billions of years of microbes.";
            return "The Cryogenian period. Snowball Earth - the planet was frozen from poles to equator.";
        }
        
        function setupControls() {
            controls.rotationX = 0;
            controls.rotationY = 0;
            controls.autoRotate = true;
            controls.mouseDown = false;
            controls.mouseX = 0;
            controls.mouseY = 0;
            controls.touches = [];
            controls.pinchDistance = 0;
            
            // Mouse controls
            renderer.domElement.addEventListener('mousedown', (e) => {
                controls.mouseDown = true;
                controls.mouseX = e.clientX;
                controls.mouseY = e.clientY;
                controls.autoRotate = false;
            });
            
            window.addEventListener('mousemove', (e) => {
                if (!controls.mouseDown) return;
                
                const deltaX = e.clientX - controls.mouseX;
                const deltaY = e.clientY - controls.mouseY;
                
                controls.rotationY += deltaX * 0.01;
                controls.rotationX += deltaY * 0.01;
                
                controls.rotationX = Math.max(-Math.PI/2, Math.min(Math.PI/2, controls.rotationX));
                
                controls.mouseX = e.clientX;
                controls.mouseY = e.clientY;
            });
            
            window.addEventListener('mouseup', () => {
                controls.mouseDown = false;
            });
            
            // Zoom
            renderer.domElement.addEventListener('wheel', (e) => {
                e.preventDefault();
                camera.position.z += e.deltaY * 0.002;
                camera.position.z = Math.max(1.5, Math.min(5, camera.position.z));
            });
            
            // Touch controls for mobile
            renderer.domElement.addEventListener('touchstart', (e) => {
                e.preventDefault();
                controls.autoRotate = false;
                
                if (e.touches.length === 1) {
                    // Single touch - rotation
                    controls.mouseDown = true;
                    controls.mouseX = e.touches[0].clientX;
                    controls.mouseY = e.touches[0].clientY;
                } else if (e.touches.length === 2) {
                    // Two fingers - pinch zoom
                    const dx = e.touches[0].clientX - e.touches[1].clientX;
                    const dy = e.touches[0].clientY - e.touches[1].clientY;
                    controls.pinchDistance = Math.sqrt(dx * dx + dy * dy);
                }
            });
            
            renderer.domElement.addEventListener('touchmove', (e) => {
                e.preventDefault();
                
                if (e.touches.length === 1 && controls.mouseDown) {
                    // Single touch - rotation
                    const deltaX = e.touches[0].clientX - controls.mouseX;
                    const deltaY = e.touches[0].clientY - controls.mouseY;
                    
                    controls.rotationY += deltaX * 0.01;
                    controls.rotationX += deltaY * 0.01;
                    
                    controls.rotationX = Math.max(-Math.PI/2, Math.min(Math.PI/2, controls.rotationX));
                    
                    controls.mouseX = e.touches[0].clientX;
                    controls.mouseY = e.touches[0].clientY;
                } else if (e.touches.length === 2) {
                    // Two fingers - pinch zoom
                    const dx = e.touches[0].clientX - e.touches[1].clientX;
                    const dy = e.touches[0].clientY - e.touches[1].clientY;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (controls.pinchDistance > 0) {
                        const scale = distance / controls.pinchDistance;
                        camera.position.z /= scale;
                        camera.position.z = Math.max(1.5, Math.min(5, camera.position.z));
                    }
                    
                    controls.pinchDistance = distance;
                }
            });
            
            renderer.domElement.addEventListener('touchend', (e) => {
                e.preventDefault();
                controls.mouseDown = false;
                controls.pinchDistance = 0;
            });
            
            // Keyboard
            window.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowUp') controls.rotationX -= 0.1;
                else if (e.key === 'ArrowDown') controls.rotationX += 0.1;
                else if (e.key === 'ArrowLeft' && !isPlaying) jumpToFrame(Math.max(0, currentFrame - 1));
                else if (e.key === 'ArrowRight' && !isPlaying) jumpToFrame(Math.min(89, currentFrame + 1));
                else if (e.key === ' ') togglePlay();
                
                controls.rotationX = Math.max(-Math.PI/2, Math.min(Math.PI/2, controls.rotationX));
            });
        }
        
        function togglePlay() {
            isPlaying = !isPlaying;
            document.getElementById('playText').textContent = isPlaying ? '⏸ Pause Animation' : '▶ Play Animation';
            document.querySelector('.control-btn').classList.toggle('active', isPlaying);
        }
        
        function setSpeed(speed) {
            animationSpeed = speed;
            frameInterval = 500 / animationSpeed;
            
            // Update button active states
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }
        
        function jumpToFrame(frame) {
            updateFrame(parseInt(frame));
        }
        
        function jumpToMYA(mya) {
            // Find the closest frame for the given MYA
            mya = parseFloat(mya);
            let closestFrame = 0;
            let closestDiff = Math.abs(getTimeForFrame(0).mya - mya);
            
            for (let i = 1; i < 90; i++) {
                const frameMYA = getTimeForFrame(i).mya;
                const diff = Math.abs(frameMYA - mya);
                if (diff < closestDiff) {
                    closestDiff = diff;
                    closestFrame = i;
                }
            }
            
            updateFrame(closestFrame);
        }
        
        async function trackLocation(name, lat, lng) {
            console.log(`Tracking location: ${name} at ${lat}, ${lng}`);
            currentLocation = { name, lat, lng };
            document.getElementById('locationInput').value = name;
            
            // Make sure pin is visible and update its position
            if (locationPin) {
                locationPin.visible = true;
                await updateLocationForFrame(currentFrame);
                
                // Immediately rotate globe to show the location
                await rotateGlobeToShowLocation(lat, lng);
            } else {
                console.error('Location pin not created yet');
            }
            
            // Pre-fetch positions for other time periods in the background (for smooth animation later)
            setTimeout(() => {
                console.log('Pre-fetching paleo positions for all time periods in background...');
                const uniqueTimes = new Set();
                for (let i = 0; i < 90; i++) {
                    const mya = getTimeForFrame(i).mya;
                    if (mya !== getTimeForFrame(currentFrame).mya) {
                        uniqueTimes.add(mya);
                    }
                }
                
                // Fetch all positions in parallel but don't wait
                const fetchPromises = Array.from(uniqueTimes).map(mya => 
                    getReconstructedPosition(lat, lng, mya).catch(e => console.warn(`Failed to cache position for ${mya} MYA`))
                );
                
                Promise.all(fetchPromises).then(() => {
                    console.log('All paleo positions cached successfully');
                });
            }, 100); // Small delay to let the immediate rotation complete first
        }
        
        async function searchLocation() {
            const input = document.getElementById('locationInput').value;
            const coords = input.match(/(-?\d+\.?\d*),\s*(-?\d+\.?\d*)/);
            
            if (coords) {
                await trackLocation('Custom', parseFloat(coords[1]), parseFloat(coords[2]));
            } else {
                // Try known cities
                const cities = {
                    'new york': [40.7128, -74.0060],
                    'london': [51.5074, -0.1278],
                    'tokyo': [35.6762, 139.6503],
                    'sydney': [-33.8688, 151.2093],
                    'paris': [48.8566, 2.3522],
                    'beijing': [39.9042, 116.4074],
                    'mumbai': [19.0760, 72.8777],
                    'cairo': [30.0444, 31.2357]
                };
                
                const city = cities[input.toLowerCase()];
                if (city) {
                    await trackLocation(input, city[0], city[1]);
                } else {
                    alert('Enter coordinates as lat,lng or try: New York, London, Tokyo, Sydney, Paris, Beijing, Mumbai, Cairo');
                }
            }
        }
        
        // Smooth globe rotation animation to show selected location
        async function rotateGlobeToShowLocation(lat, lng) {
            // Get the current paleo position for the current time frame
            const mya = getTimeForFrame(currentFrame).mya;
            const paleoPosition = await getReconstructedPosition(lat, lng, mya);
            const paleoLat = paleoPosition.lat;
            const paleoLng = paleoPosition.lng;
            
            // Calculate target rotation to center the location facing the camera
            // The globe needs to rotate so the location point faces directly toward the viewer
            
            // For longitude (Y-axis rotation):
            // We need to rotate the globe so the longitude faces forward
            // PALEOMAP textures have a 90-degree offset, and we need to negate for proper direction
            const targetRotationY = -((paleoLng + 90) * Math.PI) / 180;
            
            // For latitude (X-axis rotation):
            // We need to tilt the globe so the latitude is at the center of view
            // Positive tilt for northern latitudes, negative for southern
            const targetRotationX = (paleoLat * Math.PI) / 180;
            
            console.log(`Rotating to show ${currentLocation.name} at paleo position (${paleoLat.toFixed(1)}°, ${paleoLng.toFixed(1)}°)`);
            console.log(`Target rotations - X: ${(targetRotationX * 180 / Math.PI).toFixed(1)}°, Y: ${(targetRotationY * 180 / Math.PI).toFixed(1)}°`);
            
            // Get current rotation
            const startRotationX = controls.rotationX;
            const startRotationY = controls.rotationY;
            
            // Calculate shortest path for Y rotation (handle wrapping)
            let deltaY = targetRotationY - startRotationY;
            while (deltaY > Math.PI) deltaY -= 2 * Math.PI;
            while (deltaY < -Math.PI) deltaY += 2 * Math.PI;
            
            const deltaX = targetRotationX - startRotationX;
            
            // Disable auto-rotation during animation
            controls.autoRotate = false;
            
            // Animation duration in milliseconds
            const duration = 1500;
            const startTime = performance.now();
            
            return new Promise((resolve) => {
                function animateRotation(currentTime) {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    // Use easeInOutCubic for smooth animation
                    const easeProgress = progress < 0.5 
                        ? 4 * progress * progress * progress 
                        : 1 - Math.pow(-2 * progress + 2, 3) / 2;
                    
                    // Interpolate rotations
                    controls.rotationX = startRotationX + deltaX * easeProgress;
                    controls.rotationY = startRotationY + deltaY * easeProgress;
                    
                    // Clamp X rotation
                    controls.rotationX = Math.max(-Math.PI/2, Math.min(Math.PI/2, controls.rotationX));
                    
                    if (progress < 1) {
                        requestAnimationFrame(animateRotation);
                    } else {
                        // Animation complete
                        controls.rotationX = targetRotationX;
                        controls.rotationY = targetRotationY;
                        resolve();
                    }
                }
                
                requestAnimationFrame(animateRotation);
            });
        }
        
        // Cache for reconstructed positions
        const gplatesCache = {};
        
        // Configuration for API endpoint
        const GPLATES_CONFIG = {
            // Try these endpoints in order
            endpoints: [
                'https://deeptimewhispers.vercel.app/api/gplates/reconstruct',  // Always use production API
                null  // Fallback to calculation only if API fails
            ],
            useAPI: true  // Always use API - it should work with CORS proxy
        };
        
        // Try to use GPlates API first, fallback to calculations
        async function getReconstructedPosition(lat, lng, mya) {
            // Cache key
            const cacheKey = `${lat}_${lng}_${mya}`;
            if (gplatesCache[cacheKey]) {
                return gplatesCache[cacheKey];
            }
            
            // Try API endpoints if enabled
            if (GPLATES_CONFIG.useAPI) {
                for (const endpoint of GPLATES_CONFIG.endpoints) {
                    if (!endpoint) continue;
                    
                    try {
                        const url = `${endpoint}?points=${lng},${lat}&time=${mya}&model=MULLER2019`;
                        const response = await fetch(url);
                        
                        if (response.ok) {
                            const data = await response.json();
                            // Check if it's a GeoJSON MultiPoint (what GPlates actually returns)
                            if (data.type === 'MultiPoint' && data.coordinates && data.coordinates.length > 0) {
                                const coords = data.coordinates[0];
                                const result = { lat: coords[1], lng: coords[0] };
                                gplatesCache[cacheKey] = result;
                                console.log(`GPlates API success for ${lat},${lng} at ${mya} MYA -> [${coords[1]}, ${coords[0]}]`);
                                return result;
                            }
                            // Check if it's a FeatureCollection format
                            else if (data.features && data.features.length > 0) {
                                const coords = data.features[0].geometry.coordinates;
                                const result = { lat: coords[1], lng: coords[0] };
                                gplatesCache[cacheKey] = result;
                                // console.log(`GPlates API success for ${lat},${lng} at ${mya} MYA`);
                                return result;
                            }
                            // Check if it's a simple format
                            else if (data.coordinates) {
                                const coords = Array.isArray(data.coordinates[0]) ? data.coordinates[0] : data.coordinates;
                                const result = { lat: coords[1], lng: coords[0] };
                                gplatesCache[cacheKey] = result;
                                // console.log(`GPlates API success for ${lat},${lng} at ${mya} MYA`);
                                return result;
                            }
                        }
                    } catch (error) {
                        // Continue to next endpoint or fallback
                        console.log(`API endpoint ${endpoint} failed, trying next...`);
                    }
                }
            }
            
            // Fallback to calculation
            console.log(`FALLBACK: Using calculated position for ${lat},${lng} at ${mya} MYA (API failed)`);
            return calculateReconstructedPosition(lat, lng, mya);
        }
        
        // Calculation-based fallback
        function calculateReconstructedPosition(lat, lng, mya) {
            const cacheKey = `${lat}_${lng}_${mya}`;
            if (gplatesCache[cacheKey]) {
                return gplatesCache[cacheKey];
            }
            
            let paleoLat = lat;
            let paleoLng = lng;
            
            if (mya === 0) {
                gplatesCache[cacheKey] = { lat, lng };
                return { lat, lng };
            }
            
            // North American Plate motion - more accurate model
            if (lng > -130 && lng < -50 && lat > 15 && lat < 60) {
                // For New York specifically, we need more accurate positioning
                // Modern NY: 40.7°N, -74°W
                
                if (mya <= 50) {
                    // Recent motion: mainly westward
                    paleoLat = lat - mya * 0.02;
                    paleoLng = lng + mya * 0.15;
                } else if (mya <= 100) {
                    // Cretaceous: faster westward motion
                    paleoLat = lat - 1 - (mya - 50) * 0.05;
                    paleoLng = lng + 7.5 + (mya - 50) * 0.2;
                } else if (mya <= 180) {
                    // Jurassic: part of Laurasia
                    paleoLat = lat - 3.5 - (mya - 100) * 0.1;
                    paleoLng = lng + 17.5 + (mya - 100) * 0.15;
                } else if (mya <= 200) {
                    // Early Jurassic/Triassic boundary - Pangaea time
                    // New York was much further south and east
                    paleoLat = lat - 11.5 - (mya - 180) * 0.2;
                    paleoLng = lng + 29.5 + (mya - 180) * 0.4;
                    
                    // During Pangaea, eastern North America was rotated
                    // and positioned closer to Africa
                    if (lng > -80 && lng < -70) {  // East coast
                        paleoLat -= 5;  // Further south
                        paleoLng += 15; // Much further east
                    }
                } else if (mya <= 250) {
                    // Permian/Triassic: Deep in Pangaea
                    paleoLat = lat - 15.5 - (mya - 200) * 0.1;
                    paleoLng = lng + 37.5 + (mya - 200) * 0.15;
                    
                    // Pangaea corrections
                    if (lat > 35) {
                        paleoLat -= (lat - 35) * 0.4;
                    }
                } else {
                    // Pre-Pangaea
                    paleoLat = lat - 20.5 - (mya - 250) * 0.1;
                    paleoLng = lng + 45 + (mya - 250) * 0.1;
                }
                
                // Apply rotation correction for North America
                // During Pangaea, North America was rotated clockwise
                if (mya > 180 && mya < 250) {
                    const rotationAngle = (mya - 180) * 0.003; // More rotation during Pangaea
                    const centerLat = 35;
                    const centerLng = -90;
                    const dlat = paleoLat - centerLat;
                    const dlng = paleoLng - centerLng;
                    paleoLat = centerLat + dlat * Math.cos(rotationAngle) - dlng * Math.sin(rotationAngle);
                    paleoLng = centerLng + dlat * Math.sin(rotationAngle) + dlng * Math.cos(rotationAngle);
                }
            }
            // European Plate motion
            else if (lng > -20 && lng < 40 && lat > 35 && lat < 70) {
                if (mya <= 50) {
                    paleoLat = lat - mya * 0.03;
                    paleoLng = lng - mya * 0.02;
                } else if (mya <= 180) {
                    paleoLat = lat - 1.5 - (mya - 50) * 0.08;
                    paleoLng = lng - 1 - (mya - 50) * 0.05;
                } else {
                    // Part of Pangaea
                    paleoLat = lat - 11.9 - (mya - 180) * 0.1;
                    paleoLng = lng - 7.5 - (mya - 180) * 0.1;
                }
            }
            // Australian Plate motion
            else if (lng > 110 && lng < 160 && lat > -45 && lat < -10) {
                if (mya <= 45) {
                    // Rapid northward motion after separation from Antarctica
                    paleoLat = lat - mya * 0.35;
                    paleoLng = lng - mya * 0.05;
                } else if (mya <= 100) {
                    // Still connected to Antarctica
                    paleoLat = lat - 15.75 - (mya - 45) * 0.4;
                    paleoLng = lng - 2.25 - (mya - 45) * 0.1;
                } else if (mya <= 180) {
                    // Part of Gondwana
                    paleoLat = lat - 37.75 - (mya - 100) * 0.2;
                    paleoLng = lng - 7.75 - (mya - 100) * 0.05;
                } else {
                    // Deep time Gondwana position
                    paleoLat = lat - 53.75 - (mya - 180) * 0.1;
                    paleoLng = lng - 11.75;
                }
            }
            // African Plate motion (relatively stable)
            else if (lng > -20 && lng < 55 && lat > -35 && lat < 40) {
                paleoLat = lat - mya * 0.04;
                paleoLng = lng + mya * 0.02;
            }
            // South American Plate motion
            else if (lng > -85 && lng < -35 && lat > -55 && lat < 15) {
                if (mya <= 130) {
                    // Post Atlantic opening
                    paleoLat = lat - mya * 0.02;
                    paleoLng = lng + mya * 0.1;
                } else if (mya <= 180) {
                    // Beginning of Atlantic rifting
                    paleoLat = lat - 2.6 - (mya - 130) * 0.05;
                    paleoLng = lng + 13 + (mya - 130) * 0.25;
                } else {
                    // Part of Pangaea/Gondwana
                    paleoLat = lat - 5.1 - (mya - 180) * 0.1;
                    paleoLng = lng + 25.5 + (mya - 180) * 0.2;
                }
            }
            // Generic motion for other locations
            else {
                paleoLat = lat - mya * 0.05;
                paleoLng = lng + mya * 0.08;
            }
            
            const result = { lat: paleoLat, lng: paleoLng };
            gplatesCache[cacheKey] = result;
            return result;
        }
        
        async function updateLocationForFrame(frame) {
            if (!currentLocation || !locationPin || !earth) return;
            
            const { name, lat, lng } = currentLocation;
            const mya = getTimeForFrame(frame).mya;
            
            // Get reconstructed position
            const paleoPosition = await getReconstructedPosition(lat, lng, mya);
            const paleoLat = paleoPosition.lat;
            const paleoLng = paleoPosition.lng;
            
            // Earth radius - slightly above surface for visibility
            const radius = 1.05;
            
            // Convert degrees to radians using paleo coordinates
            const latRad = (paleoLat * Math.PI) / 180;
            // PALEOMAP textures have a 90-degree offset
            const lngRad = ((paleoLng + 90) * Math.PI) / 180;
            
            // Spherical to Cartesian conversion (Y-up coordinate system)
            const x = radius * Math.cos(latRad) * Math.sin(lngRad);
            const y = radius * Math.sin(latRad);
            const z = radius * Math.cos(latRad) * Math.cos(lngRad);
            
            // Create a group that will rotate with the Earth
            if (!locationPin.parent || locationPin.parent === scene) {
                earth.add(locationPin);
            }
            
            // Set pin position relative to Earth (which handles rotation)
            locationPin.position.set(x, y, z);
            
            // Orient pin to point outward from Earth center
            // The pin's position vector IS the outward direction
            const outwardDirection = new THREE.Vector3(x, y, z).normalize();
            
            // Default "up" vector for the pin (before rotation)
            const pinUp = new THREE.Vector3(0, 1, 0);
            
            // Calculate quaternion to rotate from default up to outward direction
            const quaternion = new THREE.Quaternion();
            quaternion.setFromUnitVectors(pinUp, outwardDirection);
            
            // Apply the rotation
            locationPin.quaternion.copy(quaternion);
            
            // Ensure pin is visible
            locationPin.visible = true;
            
            // Store current location in userData for reference (preserving animation references)
            locationPin.userData = { 
                ...locationPin.userData,  // Keep animation references
                lat: paleoLat, 
                lng: paleoLng, 
                name: name 
            };
            
            // Debug logging (reduced frequency)
            if (frame % 30 === 0) {
                console.log(`${name} at frame ${frame} (${mya} MYA): API position (${paleoLat.toFixed(1)}°, ${paleoLng.toFixed(1)}°)`);
            }
        }
        
        function animate(currentTime) {
            requestAnimationFrame(animate);
            
            // Handle animation playback (forward only)
            if (isPlaying && textures.length === 90) {
                if (currentTime - lastFrameTime > frameInterval) {
                    let nextFrame = currentFrame + 1;
                    
                    // Loop to start at end
                    if (nextFrame >= 90) {
                        nextFrame = 0;
                    }
                    
                    updateFrame(nextFrame);
                    lastFrameTime = currentTime;
                }
            }
            
            // Update Earth rotation
            if (earth) {
                if (controls.autoRotate) {
                    controls.rotationY += 0.002;
                }
                
                earth.rotation.y = controls.rotationY;
                earth.rotation.x = controls.rotationX;
            }
            
            // Location pin now rotates with Earth automatically since it's attached as a child
            // Animate the pin elements
            if (locationPin && locationPin.visible && locationPin.userData.ring) {
                const time = currentTime * 0.001;
                
                // Rotate the ring around its center (Y axis in local space)
                locationPin.userData.ring.rotation.y = time * 2;
                
                // Pulse the glow
                const pulseScale = 1 + Math.sin(time * 3) * 0.2;
                locationPin.userData.glow.scale.set(pulseScale, pulseScale, pulseScale);
                
                // Fade the beam in and out
                locationPin.userData.beam.material.opacity = 0.3 + Math.sin(time * 2) * 0.2;
            }
            
            renderer.render(scene, camera);
        }
        
        function onWindowResize() {
            const container = document.getElementById('container');
            let containerWidth = container.clientWidth;
            let containerHeight = container.clientHeight;
            
            // Force mobile dimensions if needed
            if (window.innerWidth <= 768) {
                containerWidth = window.innerWidth;
                containerHeight = window.innerHeight - 130; // Account for UI
                container.style.width = containerWidth + 'px';
                container.style.height = containerHeight + 'px';
            }
            
            camera.aspect = containerWidth / containerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(containerWidth, containerHeight);
        }
        
        // Initialize
        init();
        
        // Detect mobile and show appropriate controls hint
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        if (isMobile()) {
            document.querySelector('.desktop-controls').style.display = 'none';
            document.querySelector('.mobile-controls').style.display = 'block';
        }
        
        // For testing - load a subset first
        console.log('Loading 90 texture files for continental drift animation...');
    </script>
</body>
</html>