<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ancient Earth - Pin Debug</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
        }
        
        #container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        .debug-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            z-index: 100;
            max-width: 400px;
        }
        
        .debug-panel h3 {
            margin-bottom: 15px;
            color: #64B5F6;
        }
        
        button {
            background: #2196F3;
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        button:hover {
            background: #1976D2;
        }
        
        .coord-info {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .controls-hint {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            font-size: 13px;
            z-index: 100;
            opacity: 0.8;
        }
        
        canvas {
            display: block;
            cursor: grab;
        }
        
        canvas:active {
            cursor: grabbing;
        }
    </style>
</head>
<body>
    <div id="container">
        <div class="debug-panel">
            <h3>üîç Pin Visibility Debug</h3>
            
            <div>
                <button onclick="placeDebugPin('Sydney', -33.8688, 151.2093)">Place Sydney Pin</button>
                <button onclick="placeDebugPin('London', 51.5074, -0.1278)">Place London Pin</button>
                <button onclick="placeDebugPin('New York', 40.7128, -74.0060)">Place New York Pin</button>
            </div>
            
            <div>
                <button onclick="toggleWireframe()">Toggle Wireframe</button>
                <button onclick="togglePinSize()">Toggle Pin Size</button>
                <button onclick="resetCamera()">Reset Camera</button>
            </div>
            
            <div class="coord-info" id="coordInfo">
                Click a location button to see coordinates
            </div>
        </div>
        
        <div class="controls-hint">
            <strong>Controls:</strong><br>
            üñ±Ô∏è Drag to rotate<br>
            üìè Scroll to zoom<br>
            ‚¨ÜÔ∏è‚¨áÔ∏è Arrow keys to tilt
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Scene globals
        let scene, camera, renderer;
        let earth;
        let debugPin;
        let currentLocation = null;
        let wireframe = false;
        let largePin = false;
        
        function init() {
            // Scene setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000511);
            
            // Camera
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 0, 3);
            
            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.getElementById('container').appendChild(renderer.domElement);
            
            // Lighting - make it brighter for debugging
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);
            
            const sunlight = new THREE.DirectionalLight(0xffffff, 1);
            sunlight.position.set(5, 3, 5);
            scene.add(sunlight);
            
            // Create Earth
            createEarth();
            
            // Create debug pin
            createDebugPin();
            
            // Add reference markers
            addReferenceMarkers();
            
            // Setup controls
            setupControls();
            
            // Start render loop
            animate();
            
            // Handle window resize
            window.addEventListener('resize', onWindowResize);
        }
        
        function createEarth() {
            const geometry = new THREE.SphereGeometry(1, 64, 32);
            
            // Create Earth with blue material
            const material = new THREE.MeshPhongMaterial({
                color: 0x2194ce,
                shininess: 10,
                wireframe: false
            });
            earth = new THREE.Mesh(geometry, material);
            scene.add(earth);
            
            // Try to load texture
            const textureLoader = new THREE.TextureLoader();
            textureLoader.load(
                'textures/paleomap/timeline/Map1a PALEOMAP PaleoAtlas_000.jpg',
                (texture) => {
                    earth.material.map = texture;
                    earth.material.needsUpdate = true;
                },
                undefined,
                (error) => {
                    console.log('Texture not loaded, using blue sphere');
                }
            );
        }
        
        function createDebugPin() {
            debugPin = new THREE.Group();
            
            // Create a LARGE visible pin
            const pinMaterial = new THREE.MeshBasicMaterial({ 
                color: 0xff0000,
                emissive: 0xff0000
            });
            
            // Base sphere - make it big
            const sphereGeometry = new THREE.SphereGeometry(0.1, 16, 16);
            const sphere = new THREE.Mesh(sphereGeometry, pinMaterial);
            debugPin.add(sphere);
            
            // Vertical shaft - make it tall
            const shaftGeometry = new THREE.CylinderGeometry(0.02, 0.02, 0.4, 8);
            const shaft = new THREE.Mesh(shaftGeometry, pinMaterial);
            shaft.position.y = 0.2;
            debugPin.add(shaft);
            
            // Pin head - make it big
            const headGeometry = new THREE.SphereGeometry(0.05, 16, 16);
            const head = new THREE.Mesh(headGeometry, pinMaterial);
            head.position.y = 0.4;
            debugPin.add(head);
            
            // Add a glowing ring for extra visibility
            const ringGeometry = new THREE.TorusGeometry(0.15, 0.02, 8, 20);
            const ringMaterial = new THREE.MeshBasicMaterial({ 
                color: 0xffff00,
                emissive: 0xffff00
            });
            const ring = new THREE.Mesh(ringGeometry, ringMaterial);
            debugPin.add(ring);
            
            debugPin.visible = false;
            scene.add(debugPin);
        }
        
        function addReferenceMarkers() {
            // Add axis helper
            const axesHelper = new THREE.AxesHelper(2);
            scene.add(axesHelper);
            
            // Add grid lines
            const gridHelper = new THREE.GridHelper(4, 10);
            gridHelper.rotation.x = Math.PI / 2;
            scene.add(gridHelper);
        }
        
        function placeDebugPin(name, lat, lng) {
            console.log(`Placing pin for ${name} at ${lat}, ${lng}`);
            currentLocation = { name, lat, lng };
            
            // Multiple radius values to test
            const radiusValues = [1.0, 1.1, 1.2, 1.3];
            
            // Try different radii
            const radius = largePin ? 1.3 : 1.1;
            
            // Convert degrees to radians
            const latRad = (lat * Math.PI) / 180;
            const lngRad = (lng * Math.PI) / 180;
            
            // Include Earth's rotation
            const rotatedLng = lngRad + (earth ? earth.rotation.y : 0);
            
            // Spherical to Cartesian
            const x = radius * Math.cos(latRad) * Math.sin(rotatedLng);
            const y = radius * Math.sin(latRad);
            const z = radius * Math.cos(latRad) * Math.cos(rotatedLng);
            
            // Position and orient pin
            debugPin.position.set(x, y, z);
            debugPin.up.set(0, 1, 0);
            debugPin.lookAt(x * 2, y * 2, z * 2);
            
            // Make sure it's visible
            debugPin.visible = true;
            
            // Also create a line from center to pin for debugging
            const points = [];
            points.push(new THREE.Vector3(0, 0, 0));
            points.push(new THREE.Vector3(x, y, z));
            const lineGeometry = new THREE.BufferGeometry().setFromPoints(points);
            const lineMaterial = new THREE.LineBasicMaterial({ color: 0x00ff00 });
            
            // Remove old line if exists
            const oldLine = scene.getObjectByName('debugLine');
            if (oldLine) scene.remove(oldLine);
            
            const line = new THREE.Line(lineGeometry, lineMaterial);
            line.name = 'debugLine';
            scene.add(line);
            
            // Update info
            document.getElementById('coordInfo').innerHTML = `
                <strong>${name}</strong><br>
                Lat: ${lat}¬∞, Lng: ${lng}¬∞<br>
                Lat (rad): ${latRad.toFixed(3)}, Lng (rad): ${lngRad.toFixed(3)}<br>
                Rotated Lng: ${rotatedLng.toFixed(3)}<br>
                Cartesian: x=${x.toFixed(3)}, y=${y.toFixed(3)}, z=${z.toFixed(3)}<br>
                Radius: ${radius}<br>
                Pin visible: ${debugPin.visible}<br>
                Earth rotation: ${earth ? earth.rotation.y.toFixed(3) : 0}
            `;
            
            // Log to console
            console.log('Pin position:', { x, y, z });
            console.log('Pin object:', debugPin);
        }
        
        function toggleWireframe() {
            wireframe = !wireframe;
            if (earth) {
                earth.material.wireframe = wireframe;
            }
        }
        
        function togglePinSize() {
            largePin = !largePin;
            if (currentLocation) {
                placeDebugPin(currentLocation.name, currentLocation.lat, currentLocation.lng);
            }
        }
        
        function resetCamera() {
            camera.position.set(0, 0, 3);
            camera.lookAt(0, 0, 0);
            if (earth) {
                earth.rotation.set(0, 0, 0);
            }
        }
        
        function setupControls() {
            let mouseDown = false;
            let mouseX = 0, mouseY = 0;
            
            renderer.domElement.addEventListener('mousedown', (e) => {
                mouseDown = true;
                mouseX = e.clientX;
                mouseY = e.clientY;
            });
            
            window.addEventListener('mousemove', (e) => {
                if (!mouseDown || !earth) return;
                
                const deltaX = e.clientX - mouseX;
                const deltaY = e.clientY - mouseY;
                
                earth.rotation.y += deltaX * 0.01;
                earth.rotation.x += deltaY * 0.01;
                
                mouseX = e.clientX;
                mouseY = e.clientY;
                
                // Update pin position as Earth rotates
                if (currentLocation) {
                    placeDebugPin(currentLocation.name, currentLocation.lat, currentLocation.lng);
                }
            });
            
            window.addEventListener('mouseup', () => {
                mouseDown = false;
            });
            
            // Zoom
            renderer.domElement.addEventListener('wheel', (e) => {
                e.preventDefault();
                camera.position.z += e.deltaY * 0.002;
                camera.position.z = Math.max(1.5, Math.min(5, camera.position.z));
            });
        }
        
        function animate() {
            requestAnimationFrame(animate);
            
            // Make the pin rotate for visibility
            if (debugPin && debugPin.visible) {
                const ring = debugPin.children[3]; // The yellow ring
                if (ring) {
                    ring.rotation.z += 0.02;
                }
            }
            
            renderer.render(scene, camera);
        }
        
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        // Initialize
        init();
        
        // Place Sydney pin after a short delay
        setTimeout(() => {
            placeDebugPin('Sydney', -33.8688, 151.2093);
        }, 500);
    </script>
</body>
</html>