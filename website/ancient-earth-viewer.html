<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ancient Earth - Deep Time Whispers</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Raleway:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-purple: #7B1FA2;
            --deep-purple: #4A148C;
            --cosmic-teal: #4DB6AC;
            --midnight: #1A237E;
            --stardust: #E1BEE7;
            --nebula: #7E57C2;
            --space-black: #0A0E27;
            --soft-white: #F5F5F5;
            --text-light: #B39DDB;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Raleway', sans-serif;
            background: var(--space-black);
            color: var(--soft-white);
            overflow: hidden;
            position: relative;
            height: 100vh;
        }
        
        #container {
            width: 100vw;
            height: 100vh;
            position: relative;
            overflow: hidden;
        }
        
        /* Cosmic Background Animation */
        .cosmic-bg {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
            background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
            overflow: hidden;
        }
        
        .stars, .stars2, .stars3 {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .stars {
            width: 1px;
            height: 1px;
            background: transparent;
            box-shadow: 779px 1331px #fff, 324px 42px #fff, 303px 586px #fff, 1312px 276px #fff, 451px 625px #fff;
            animation: drift 120s linear infinite;
        }
        
        @keyframes drift {
            from { transform: translateY(0px); }
            to { transform: translateY(-1000px); }
        }
        
        /* Navigation */
        .nav {
            position: fixed;
            top: 0;
            width: 100%;
            background: rgba(10, 14, 39, 0.9);
            backdrop-filter: blur(10px);
            z-index: 1000;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem 2rem;
        }
        
        .logo-text {
            font-family: 'Crimson Text', serif;
            font-size: 1.8rem;
            font-weight: 600;
            background: linear-gradient(45deg, var(--stardust), var(--cosmic-teal));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-decoration: none;
        }
        
        .nav-links {
            display: flex;
            gap: 2rem;
            align-items: center;
        }
        
        .nav-link {
            color: var(--text-light);
            text-decoration: none;
            transition: color 0.3s ease;
            font-weight: 400;
        }
        
        .nav-link:hover {
            color: var(--cosmic-teal);
        }
        
        .nav-link.active {
            color: var(--cosmic-teal);
        }
        
        /* Top controls bar */
        .top-bar {
            position: fixed;
            top: 80px;
            left: 0;
            right: 0;
            background: rgba(10, 14, 39, 0.9);
            padding: 15px 20px;
            text-align: center;
            z-index: 100;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            height: 120px; /* Fixed height for consistent spacing */
        }
        
        h1 {
            font-family: 'Crimson Text', serif;
            font-size: 2rem;
            font-weight: 400;
            margin-bottom: 10px;
            letter-spacing: 1px;
            background: linear-gradient(45deg, var(--stardust), var(--cosmic-teal));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Animation controls */
        .animation-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 5px;
        }
        
        .btn {
            background: linear-gradient(45deg, var(--primary-purple), var(--nebula));
            border: none;
            color: white;
            padding: 8px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(123, 31, 162, 0.4);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(123, 31, 162, 0.6);
        }
        
        .btn.active {
            background: linear-gradient(45deg, var(--cosmic-teal), var(--nebula));
        }
        
        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #ccc;
        }
        
        .speed-slider {
            width: 100px;
            cursor: pointer;
        }
        
        /* Timeline */
        .timeline-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px 30px;
            background: rgba(10, 14, 39, 0.95);
            z-index: 100;
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            height: 100px;
        }
        
        .timeline-slider {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: #333;
            border-radius: 3px;
            outline: none;
            margin-bottom: 20px;
            cursor: pointer;
        }
        
        .timeline-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--cosmic-teal);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(77, 182, 172, 0.8);
        }
        
        .timeline-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--cosmic-teal);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(77, 182, 172, 0.8);
        }
        
        .timeline-labels {
            display: flex;
            justify-content: space-between;
            color: var(--text-light);
            font-size: 12px;
            user-select: none;
        }
        
        /* Info panel */
        .info-panel {
            position: fixed;
            left: 20px;
            top: 220px; /* Below the top bar */
            background: rgba(10, 14, 39, 0.9);
            padding: 20px;
            border-radius: 15px;
            max-width: 280px;
            z-index: 100;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .period-name {
            font-family: 'Crimson Text', serif;
            font-size: 22px;
            color: var(--cosmic-teal);
            margin-bottom: 6px;
        }
        
        .mya-display {
            font-size: 16px;
            color: var(--stardust);
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .period-description {
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
        }
        
        /* Location tracking */
        .location-panel {
            position: fixed;
            right: 20px;
            top: 220px; /* Below the top bar */
            background: rgba(10, 14, 39, 0.9);
            padding: 20px;
            border-radius: 15px;
            width: 260px;
            z-index: 100;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .location-panel h3 {
            font-family: 'Crimson Text', serif;
            font-size: 18px;
            margin-bottom: 12px;
            color: var(--cosmic-teal);
        }
        
        .location-search {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .location-search input {
            flex: 1;
            padding: 10px 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: var(--soft-white);
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .location-search input:focus {
            outline: none;
            border-color: var(--cosmic-teal);
            background: rgba(255, 255, 255, 0.1);
        }
        
        .location-search button {
            padding: 10px 20px;
            background: linear-gradient(45deg, var(--cosmic-teal), var(--nebula));
            border: none;
            color: white;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .location-search button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(77, 182, 172, 0.5);
        }
        
        .location-presets {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .preset-btn {
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--soft-white);
            border-radius: 10px;
            cursor: pointer;
            text-align: left;
            transition: all 0.3s ease;
        }
        
        .preset-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--cosmic-teal);
            transform: translateX(5px);
        }
        
        .current-location {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 13px;
            color: var(--text-light);
            line-height: 1.5;
        }
        
        #globeViz {
            width: 100%;
            height: calc(100vh - 300px); /* Account for nav (80px) + top-bar (120px) + timeline (100px) */
            margin-top: 80px; /* Start below the nav */
            position: relative;
        }
        
        .loading-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 22px;
            color: var(--cosmic-teal);
            font-family: 'Crimson Text', serif;
            letter-spacing: 2px;
        }

        /* Tablet adjustments */
        @media (max-width: 1024px) and (min-width: 769px) {
            .info-panel {
                max-width: 240px;
                padding: 18px;
            }
            
            .location-panel {
                width: 240px;
                padding: 18px;
            }
        }
        
        /* Mobile adjustments */
        @media (max-width: 768px) {
            #globeViz {
                height: calc(100vh - 280px); /* Account for nav + top + timeline on mobile */
            }
            
            .top-bar {
                height: 100px; /* Reduced height for mobile */
                padding: 10px 15px;
            }
            
            h1 {
                font-size: 1.5rem;
                margin-bottom: 8px;
            }
            
            .animation-controls {
                flex-direction: column;
                gap: 8px;
            }
            
            .btn {
                padding: 6px 16px;
                font-size: 13px;
            }
            
            .info-panel, .location-panel {
                position: fixed;
                left: 10px;
                right: 10px;
                max-width: none;
                width: auto;
                padding: 15px;
                top: 190px; /* Below mobile top bar */
            }
            
            .location-panel {
                top: auto;
                bottom: 120px; /* Above timeline */
                max-height: 200px;
                overflow-y: auto;
            }
            
            .timeline-container {
                padding: 15px;
                height: 80px;
            }
        }
        
        /* Very small screens */
        @media (max-width: 480px) {
            .nav-content {
                padding: 1rem;
            }
            
            .logo-text {
                font-size: 1.4rem;
            }
            
            .nav-links {
                gap: 1rem;
                font-size: 0.9rem;
            }
            
            h1 {
                font-size: 1.3rem;
            }
            
            .info-panel, .location-panel {
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Cosmic Background Animation -->
    <div class="cosmic-bg">
        <div class="stars"></div>
        <div class="stars2"></div>
        <div class="stars3"></div>
    </div>
    
    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-content">
            <a href="index.html" class="logo-text">Deep Time Whispers</a>
            <div class="nav-links">
                <a href="index.html#listen" class="nav-link">Listen</a>
                <a href="index.html#stories" class="nav-link">Episodes</a>
                <a href="timeline.html" class="nav-link">Timeline</a>
                <a href="ancient-earth-viewer.html" class="nav-link active">Ancient Earth</a>
                <a href="index.html#about" class="nav-link">About</a>
            </div>
        </div>
    </nav>
    
    <div id="container">
        <!-- Globe visualization -->
        <div id="globeViz">
            <div class="loading-message">Awakening Ancient Memories...</div>
        </div>
        
        <!-- Top controls -->
        <div class="top-bar">
            <h1>Journey Through Ancient Earth</h1>
            <div class="animation-controls">
                <button class="btn" id="playBtn" onclick="toggleAnimation()">
                    ▶ Play Animation
                </button>
                <button class="btn" onclick="jumpToTime(0)">
                    ↻ Forward in Time
                </button>
                <div class="speed-control">
                    <span>Speed:</span>
                    <input type="range" class="speed-slider" id="speedSlider" min="0.5" max="5" value="1" step="0.5">
                    <span id="speedValue">1x</span>
                </div>
            </div>
        </div>
        
        <!-- Info panel -->
        <div class="info-panel">
            <div class="period-name" id="periodName">Present Day</div>
            <div class="mya-display" id="myaDisplay">0 Million Years Ago</div>
            <div class="period-description" id="periodDescription">
                The modern world with seven continents. Ice caps at both poles define our current interglacial period.
            </div>
        </div>
        
        <!-- Location panel -->
        <div class="location-panel">
            <h3>Track a Location</h3>
            
            <!-- Coordinate input -->
            <div style="margin-bottom: 15px;">
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="text" id="latInput" placeholder="Latitude" style="flex: 1; padding: 10px; border: 1px solid rgba(255, 255, 255, 0.2); background: rgba(255, 255, 255, 0.05); color: var(--soft-white); border-radius: 10px;">
                    <input type="text" id="lngInput" placeholder="Longitude" style="flex: 1; padding: 10px; border: 1px solid rgba(255, 255, 255, 0.2); background: rgba(255, 255, 255, 0.05); color: var(--soft-white); border-radius: 10px;">
                </div>
                <button onclick="trackCustomLocation()" style="width: 100%; padding: 10px; background: linear-gradient(45deg, var(--cosmic-teal), var(--nebula)); border: none; color: white; border-radius: 50px; cursor: pointer; transition: all 0.3s ease;">Track Coordinates</button>
            </div>
            
            <div style="text-align: center; margin: 10px 0; color: #666;">— or —</div>
            
            <div class="location-presets">
                <button class="preset-btn" onclick="setLocation(40.7128, -74.0060, 'New York')">New York</button>
                <button class="preset-btn" onclick="setLocation(51.5074, -0.1278, 'London')">London</button>
                <button class="preset-btn" onclick="setLocation(35.6762, 139.6503, 'Tokyo')">Tokyo</button>
                <button class="preset-btn" onclick="setLocation(-33.8688, 151.2093, 'Sydney')">Sydney</button>
                <button class="preset-btn" onclick="setLocation(36.1069, -112.1129, 'Grand Canyon')">Grand Canyon</button>
                <button class="preset-btn" onclick="setLocation(64.9631, -19.0208, 'Iceland')">Iceland</button>
            </div>
            
            <div class="current-location" id="currentLocation"></div>
            
            <!-- Share button -->
            <button id="shareBtn" onclick="shareLocation()" style="display: none; width: 100%; margin-top: 15px; padding: 12px; background: linear-gradient(45deg, var(--primary-purple), var(--nebula)); border: none; color: white; border-radius: 50px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 20px rgba(123, 31, 162, 0.4);">Share This Journey</button>
        </div>
        
        <!-- Timeline -->
        <div class="timeline-container">
            <input type="range" class="timeline-slider" id="timeSlider" min="0" max="750" value="0" step="1">
            <div class="timeline-labels">
                <span>Present</span>
                <span>100 MYA</span>
                <span>200 MYA</span>
                <span>300 MYA</span>
                <span>400 MYA</span>
                <span>500 MYA</span>
                <span>600 MYA</span>
                <span>750 MYA</span>
            </div>
        </div>
    </div>

    <!-- Globe.gl (includes Three.js) -->
    <script src="//unpkg.com/globe.gl@2.27.2/dist/globe.gl.min.js"></script>
    
    <!-- Main application -->
    <script>
        // Initialize globe
        let globe = null;
        let currentMYA = 0;
        let currentLocation = null;
        let isAnimating = false;
        let animationSpeed = 1; // Slower default speed
        let preloadedTextures = {};
        let locationCache = {}; // Cache API responses
        let lastLocationUpdate = -1; // Track last API call time
        let lastAPICallTime = 0; // Track actual time of last API call
        const API_THROTTLE_MS = 2000; // Minimum 2 seconds between API calls
        
        // Preload textures for smoother transitions
        function preloadTextures() {
            const uniqueTextures = [...new Set(Object.values(timePeriods).map(p => p.texture))];
            uniqueTextures.forEach(texture => {
                const img = new Image();
                img.onload = () => {
                    preloadedTextures[texture] = true;
                };
                img.src = texture;
            });
        }
        
        // Time periods data with texture mapping
        const timePeriods = {
            0: { name: "Present Day", description: "Modern Earth with seven continents", texture: "textures/paleomap/timeline/Map1a PALEOMAP PaleoAtlas_000.jpg" },
            1: { name: "Last Glacial Maximum", description: "Ice age at its peak", texture: "textures/paleomap/timeline/Map2a Last Glacial Maximum_001.jpg" },
            6: { name: "Messinian", description: "Mediterranean dried up", texture: "textures/paleomap/timeline/Map4a Messinian Event_006.jpg" },
            10: { name: "Late Miocene", description: "Cooling climate, grasslands expand", texture: "textures/paleomap/timeline/Map5a Late Miocene_010.jpg" },
            15: { name: "Middle Miocene", description: "Warm period, modern animals evolve", texture: "textures/paleomap/timeline/Map6a  Middle Miocene_015.jpg" },
            20: { name: "Early Miocene", description: "Early human ancestors appear", texture: "textures/paleomap/timeline/Map7a  Early Miocene_020.jpg" },
            35: { name: "Late Eocene", description: "Antarctica freezes", texture: "textures/paleomap/timeline/Map10a Late Eocene_035.jpg" },
            55: { name: "PETM", description: "Extreme global warming", texture: "textures/paleomap/timeline/Map14a PETM_055.jpg" },
            66: { name: "End Cretaceous", description: "Dinosaur extinction event", texture: "textures/paleomap/timeline/Map16a KT Boundary_066.jpg" },
            90: { name: "Turonian", description: "High sea levels, warm climate", texture: "textures/paleomap/timeline/Map21a LtK Turonian_090.jpg" },
            120: { name: "Early Aptian", description: "Flowering plants diversify", texture: "textures/paleomap/timeline/Map27a EK Early Albian_120.jpg" },
            150: { name: "Late Jurassic", description: "Age of giant dinosaurs", texture: "textures/paleomap/timeline/Map33a LtJ Tithonian_150.jpg" },
            170: { name: "Middle Jurassic", description: "Pangaea breaking apart", texture: "textures/paleomap/timeline/Map37a MJ Bajocian&Bathonian_170.jpg" },
            200: { name: "Triassic-Jurassic", description: "Mass extinction, dinosaurs rise", texture: "textures/paleomap/timeline/Map43a Triassic-Jurassic Boundary_200.jpg" },
            220: { name: "Carnian", description: "Wet period, dinosaurs diversify", texture: "textures/paleomap/timeline/Map45a LtTr Carnian_220.jpg" },
            250: { name: "End Permian", description: "The Great Dying - worst extinction", texture: "textures/paleomap/timeline/Map49a Permo-Triassic Boundary_250.jpg" },
            280: { name: "Early Permian", description: "Supercontinent Pangaea forms", texture: "textures/paleomap/timeline/Map54a EP Artinskian_280.jpg" },
            300: { name: "Carboniferous", description: "Coal swamp forests", texture: "textures/paleomap/timeline/Map57a LtCarb Gzhelian_300.jpg" },
            340: { name: "Early Carboniferous", description: "Trees dominate land", texture: "textures/paleomap/timeline/Map63a ECarb Early Visean_340.jpg" },
            380: { name: "Late Devonian", description: "First forests appear", texture: "textures/paleomap/timeline/Map67a LtD Frasnian_380.jpg" },
            400: { name: "Early Devonian", description: "First trees and land vertebrates", texture: "textures/paleomap/timeline/Map70a ED Emsian_400.jpg" },
            440: { name: "Early Silurian", description: "Life recovers after extinction", texture: "textures/paleomap/timeline/Map76a ES early Llandovery_440.jpg" },
            480: { name: "Early Ordovician", description: "Marine life flourishes", texture: "textures/paleomap/timeline/Map82a EO Tremadoc_480.jpg" },
            520: { name: "Middle Cambrian", description: "Cambrian explosion continues", texture: "textures/paleomap/timeline/Map86a Middle Cambrian Series 2_520.jpg" },
            540: { name: "Cambrian", description: "Explosion of complex life", texture: "textures/paleomap/timeline/Map88a Precambrian-Cambrian Boundary_540.jpg" },
            600: { name: "Ediacaran", description: "First complex organisms", texture: "textures/paleomap/timeline/Map90a Middle Ediacaran_600.jpg" },
            750: { name: "Cryogenian", description: "Snowball Earth - planet frozen", texture: "textures/paleomap/timeline/Map93a MIddle Cryogenian_750.jpg" }
        };
        
        // Initialize on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                preloadTextures();
                initGlobe();
                setupEventListeners();
                loadSharedLocation();
            });
        } else {
            // DOM already loaded
            preloadTextures();
            initGlobe();
            setupEventListeners();
            loadSharedLocation();
        }
        
        // Load location from URL if shared
        function loadSharedLocation() {
            const params = new URLSearchParams(window.location.search);
            
            if (params.has('lat') && params.has('lng')) {
                const lat = parseFloat(params.get('lat'));
                const lng = parseFloat(params.get('lng'));
                const name = params.get('name') || 'Shared Location';
                const mya = parseInt(params.get('mya') || '0');
                
                // Set the time first
                jumpToTime(mya);
                
                // Then set the location
                setTimeout(() => {
                    setLocation(lat, lng, name);
                }, 500);
            }
        }
        
        function initGlobe() {
            const container = document.getElementById('globeViz');
            
            globe = Globe()
                .globeImageUrl(getTextureForTime(0))
                .bumpImageUrl('//unpkg.com/three-globe/example/img/earth-topology.png')
                .showAtmosphere(true)
                .atmosphereColor('lightskyblue')
                .atmosphereAltitude(0.1)
                (container);
                
            // Configure point appearance globally
            globe
                .pointAltitude(0.01)
                .pointRadius(0.6)
                .pointColor(() => '#4DB6AC')
                .pointResolution(16);
            
            // Adjust lighting to reduce brightness
            const scene = globe.scene();
            const directionalLight = scene.children.find(obj => obj.type === 'DirectionalLight');
            if (directionalLight) {
                directionalLight.intensity = 0.3; // Further reduced for more even lighting
                directionalLight.position.set(10, 3, 5); // Move light to the side to reduce direct reflection
            }
            
            // Add subtle ambient light
            if (typeof THREE !== 'undefined') {
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.15); // Slightly increased for more even illumination
                scene.add(ambientLight);
            }
            
            // Adjust globe material to be less shiny
            const globeMaterial = globe.globeMaterial();
            globeMaterial.shininess = 1; // Minimal shininess
            if (typeof THREE !== 'undefined' && globeMaterial.specular) {
                globeMaterial.specular = new THREE.Color(0x050505); // Very dark specular highlights
                globeMaterial.emissive = new THREE.Color(0x000000); // No emissive light
                if (globeMaterial.color) {
                    globeMaterial.color.multiplyScalar(0.85); // Slightly darken the overall texture
                }
            }
            
            // Set initial view - higher altitude to fit better in viewport
            globe.pointOfView({ lat: 20, lng: 0, altitude: 3.2 });
            
            // Hide loading message
            const loadingMsg = document.querySelector('.loading-message');
            if (loadingMsg) {
                loadingMsg.style.display = 'none';
            }
        }
        
        function setupEventListeners() {
            // Timeline slider
            const slider = document.getElementById('timeSlider');
            slider.addEventListener('input', function(e) {
                jumpToTime(parseInt(e.target.value));
            });
            
            // Speed control
            const speedSlider = document.getElementById('speedSlider');
            speedSlider.addEventListener('input', function(e) {
                animationSpeed = parseFloat(e.target.value);
                document.getElementById('speedValue').textContent = animationSpeed.toFixed(1) + 'x';
            });
        }
        
        function jumpToTime(mya) {
            currentMYA = mya;
            updateDisplay(mya);
            updateGlobeForTime(mya);
            
            // Update slider if not already set
            document.getElementById('timeSlider').value = mya;
            
            // Update location if tracking
            if (currentLocation) {
                updateLocationForTime(mya);
            }
        }
        
        function updateDisplay(mya) {
            // Find closest time period
            const times = Object.keys(timePeriods).map(Number).sort((a, b) => a - b);
            let closestTime = times[0];
            let minDiff = Math.abs(mya - closestTime);
            
            for (const time of times) {
                const diff = Math.abs(mya - time);
                if (diff < minDiff) {
                    minDiff = diff;
                    closestTime = time;
                }
            }
            
            const period = timePeriods[closestTime];
            document.getElementById('periodName').textContent = period.name;
            document.getElementById('myaDisplay').textContent = mya + ' Million Years Ago';
            document.getElementById('periodDescription').textContent = period.description;
        }
        
        function getTextureForTime(mya) {
            // Find the closest time period with a texture
            const times = Object.keys(timePeriods).map(Number).sort((a, b) => a - b);
            let closestTime = times[0];
            let minDiff = Math.abs(mya - closestTime);
            
            for (const time of times) {
                const diff = Math.abs(mya - time);
                if (diff < minDiff) {
                    minDiff = diff;
                    closestTime = time;
                }
            }
            
            return timePeriods[closestTime].texture;
        }
        
        function updateGlobeForTime(mya) {
            // Update texture
            const texture = getTextureForTime(mya);
            
            // Show loading state briefly if texture not preloaded
            if (!preloadedTextures[texture]) {
                const loadingMsg = document.querySelector('.loading-message');
                if (loadingMsg) {
                    loadingMsg.style.display = 'block';
                    loadingMsg.textContent = 'Loading ancient Earth...';
                }
            }
            
            globe.globeImageUrl(texture);
            
            // Hide loading message once texture loads
            globe.onGlobeReady(() => {
                const loadingMsg = document.querySelector('.loading-message');
                if (loadingMsg) {
                    loadingMsg.style.display = 'none';
                }
            });
            
            // Update atmosphere based on time
            if (mya > 600) {
                globe.atmosphereColor('white');
                globe.atmosphereAltitude(0.25);
            } else if (mya > 250) {
                globe.atmosphereColor('orange');
                globe.atmosphereAltitude(0.2);
            } else {
                globe.atmosphereColor('lightskyblue');
                globe.atmosphereAltitude(0.15);
            }
        }
        
        function toggleAnimation() {
            isAnimating = !isAnimating;
            const btn = document.getElementById('playBtn');
            
            if (isAnimating) {
                btn.innerHTML = '<span>⏸</span> Pause';
                btn.classList.add('active');
                animateTimeline();
            } else {
                btn.innerHTML = '<span>▶</span> Play Animation';
                btn.classList.remove('active');
            }
        }
        
        function animateTimeline() {
            if (!isAnimating) return;
            
            // Move forward in time (slower animation)
            currentMYA += animationSpeed * 0.5; // Even slower for smoother animation
            if (currentMYA > 750) {
                currentMYA = 0;
            }
            
            // Update display and globe
            updateDisplay(currentMYA);
            updateGlobeForTime(currentMYA);
            document.getElementById('timeSlider').value = currentMYA;
            
            // Update location tracking at intervals during animation
            if (currentLocation) {
                const now = Date.now();
                if (now - lastAPICallTime > 500) { // Update every 500ms max
                    lastAPICallTime = now;
                    updateLocationForTime(currentMYA);
                }
            }
            
            // Continue animation
            requestAnimationFrame(animateTimeline);
        }
        
        function setLocation(lat, lng, name) {
            currentLocation = { lat, lng, name };
            locationCache = {}; // Clear cache when changing location
            lastLocationUpdate = -1;
            
            // Add point to globe
            globe.pointsData([{
                lat: lat,
                lng: lng,
                color: '#4DB6AC',
                size: 1,
                label: name
            }]);
            
            // Update display
            document.getElementById('currentLocation').innerHTML = 
                `<strong>${name}</strong><br>
                 ${lat.toFixed(2)}°, ${lng.toFixed(2)}°<br>
                 <span id="ancientPos" style="color: var(--cosmic-teal); font-size: 11px;"></span>`;
            
            // Show share button
            document.getElementById('shareBtn').style.display = 'block';
            
            // Focus on location
            globe.pointOfView({ lat, lng, altitude: 2.5 }, 1000);
            
            // Update for current time
            updateLocationForTime(currentMYA);
        }
        
        function trackCustomLocation() {
            const lat = parseFloat(document.getElementById('latInput').value);
            const lng = parseFloat(document.getElementById('lngInput').value);
            
            if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                alert('Please enter valid coordinates\nLatitude: -90 to 90\nLongitude: -180 to 180');
                return;
            }
            
            setLocation(lat, lng, 'Custom Location');
        }
        
        function shareLocation() {
            if (!currentLocation) return;
            
            const params = new URLSearchParams({
                lat: currentLocation.lat.toFixed(4),
                lng: currentLocation.lng.toFixed(4),
                name: currentLocation.name,
                mya: currentMYA
            });
            
            const shareUrl = `${window.location.origin}${window.location.pathname}?${params.toString()}`;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    alert('Share link copied to clipboard!');
                }).catch(() => {
                    prompt('Copy this link:', shareUrl);
                });
            } else {
                prompt('Copy this link:', shareUrl);
            }
        }
        
        function searchLocation() {
            const query = document.getElementById('locationInput').value;
            if (!query) return;
            
            // For demo, just use a few presets
            const locations = {
                'new york': { lat: 40.7128, lng: -74.0060, name: 'New York' },
                'london': { lat: 51.5074, lng: -0.1278, name: 'London' },
                'tokyo': { lat: 35.6762, lng: 139.6503, name: 'Tokyo' },
                'sydney': { lat: -33.8688, lng: 151.2093, name: 'Sydney' }
            };
            
            const location = locations[query.toLowerCase()];
            if (location) {
                setLocation(location.lat, location.lng, location.name);
            }
        }
        
        async function updateLocationForTime(mya) {
            if (!currentLocation) return;
            
            // Round MYA to nearest 5 for caching
            const roundedMYA = Math.round(mya / 5) * 5;
            
            // For present day, just show current location
            if (roundedMYA === 0) {
                globe.pointsData([{
                    lat: currentLocation.lat,
                    lng: currentLocation.lng,
                    color: '#4DB6AC',
                    size: 1,
                    label: currentLocation.name
                }]);
                
                const ancientPosEl = document.getElementById('ancientPos');
                if (ancientPosEl) {
                    ancientPosEl.textContent = '';
                    ancientPosEl.style.color = '';
                }
                return;
            }
            
            // Check cache first (use rounded MYA for cache key)
            const cacheKey = `${currentLocation.lat},${currentLocation.lng},${roundedMYA}`;
            if (locationCache[cacheKey]) {
                const cached = locationCache[cacheKey];
                globe.pointsData([{
                    lat: cached.lat,
                    lng: cached.lng,
                    color: '#4DB6AC',
                    size: 1,
                    label: currentLocation.name + ' (' + Math.round(mya) + ' MYA)'
                }]);
                
                const ancientPosEl = document.getElementById('ancientPos');
                if (ancientPosEl) {
                    ancientPosEl.textContent = `Ancient: ${cached.lat.toFixed(2)}°, ${cached.lng.toFixed(2)}°`;
                    ancientPosEl.style.color = '';
                }
                return;
            }
            
            try {
                // Use the GPlates API
                // Always use the deployed Vercel API for GPlates calls
                const url = `https://deeptimewhispers.vercel.app/api/gplates/reconstruct?points=${currentLocation.lng},${currentLocation.lat}&time=${roundedMYA}&model=MULLER2019`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`API responded with status ${response.status}`);
                }
                
                const data = await response.json();
                
                let ancientLat, ancientLng;
                
                if (data.type === 'MultiPoint' && data.coordinates && data.coordinates.length > 0) {
                    ancientLng = data.coordinates[0][0];
                    ancientLat = data.coordinates[0][1];
                } else if (data.coordinates && Array.isArray(data.coordinates)) {
                    // Handle different response format
                    ancientLng = data.coordinates[0];
                    ancientLat = data.coordinates[1];
                } else {
                    throw new Error('Invalid response format from GPlates API');
                }
                
                // Cache the result
                locationCache[cacheKey] = { lat: ancientLat, lng: ancientLng };
                
                globe.pointsData([{
                    lat: ancientLat,
                    lng: ancientLng,
                    color: '#4DB6AC',
                    size: 1,
                    label: currentLocation.name + ' (' + Math.round(mya) + ' MYA)'
                }]);
                
                // Update ancient position display
                const ancientPosEl = document.getElementById('ancientPos');
                if (ancientPosEl && roundedMYA > 0) {
                    ancientPosEl.textContent = `Ancient: ${ancientLat.toFixed(2)}°, ${ancientLng.toFixed(2)}°`;
                }
                
            } catch (error) {
                console.error('GPlates API error:', error);
                // Simple fallback - no drift shown if API fails
                globe.pointsData([{
                    lat: currentLocation.lat,
                    lng: currentLocation.lng,
                    color: '#FF6B6B',
                    size: 1,
                    label: currentLocation.name + ' (tracking unavailable)'
                }]);
                
                const ancientPosEl = document.getElementById('ancientPos');
                if (ancientPosEl) {
                    ancientPosEl.textContent = 'Continental drift data unavailable';
                    ancientPosEl.style.color = '#FF6B6B';
                }
            }
        }
    </script>
</body>
</html>